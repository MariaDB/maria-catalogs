--source include/have_debug.inc
# Valgrind does not work well with test that crashes the server
--source include/not_valgrind.inc
--source include/master-slave.inc

--echo *** Test crashing master with InnoDB disabled, the binlog gtid state should still be correctly recovered. ***

--connection master
CREATE TABLE t1 (a INT PRIMARY KEY) ENGINE=MyISAM;
--sync_slave_with_master

--connection slave_config
--source include/stop_slave.inc
CHANGE MASTER TO master_use_gtid=slave_pos;
--source include/start_slave.inc

--connection master
INSERT INTO t1 VALUES (1);
INSERT INTO t1 VALUES (2);

--sync_slave_with_master
SELECT * FROM t1 ORDER BY a;

--connection master

--write_file $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
wait
EOF

FLUSH TABLES;
SET SESSION debug_dbug="+d,crash_dispatch_command_before";
--error 2006,2013
SELECT 1;

--source include/wait_until_disconnected.inc

--append_file $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
restart-rpl_gtid_crash.test
EOF

--source include/reconnect_master.inc

INSERT INTO t1 VALUES (3);

--sync_slave_with_master

SELECT * FROM t1 ORDER BY a;

--connection master
DROP TABLE t1;

--source include/rpl_end.inc
